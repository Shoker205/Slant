<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slant - Neural Fluid</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;900&display=swap');

        :root {
            --bg: #000;
            --accent: #fff;
            --field: #0e0e0e;
            --border: #1a1a1a;
            --error: #ff3b30;
            --success: #34c759;
            --text-main: #eee;
            --text-dim: #666;
            --radius: 24px;
            --particle-color: #fff;
        }

        [data-theme="light"] {
            --bg: #f5f5f7;
            --accent: #000;
            --field: #ffffff;
            --border: #d2d2d7;
            --text-main: #1d1d1f;
            --text-dim: #86868b;
            --particle-color: #000;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.4s ease;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            background: var(--field);
            color: var(--text-main);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: grab;
            user-select: none;
            transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.3s;
            border-left: 3px solid var(--error);
            border-right: 1px solid var(--border);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        .toast.success { border-left-color: var(--success); }

        .auth-card {
            width: 90%;
            max-width: 340px;
            background: transparent;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            color: var(--text-dim);
            transition: color 0.2s;
            z-index: 100;
        }
        .theme-toggle:hover { color: var(--accent); }

        .back-btn {
            position: absolute;
            top: -10px;
            left: -10px;
            background: none;
            border: none;
            padding: 15px;
            cursor: pointer;
            z-index: 10;
            color: var(--text-dim);
            transition: color 0.2s;
        }
        .back-btn:hover { color: var(--accent); }

        .mascot-container {
            width: 100%;
            height: 160px;
            position: relative;
            margin-bottom: 5px;
        }

        #mascot { width: 100%; height: 100%; display: block; }

        .brand-header { text-align: center; margin-bottom: 30px; }
        .brand-header h1 {
            font-weight: 900; letter-spacing: 12px; font-size: 24px;
            margin: 0; color: var(--accent); text-indent: 12px; text-transform: uppercase;
        }
        .brand-header.small h1 { font-size: 18px; letter-spacing: 6px; text-indent: 6px; }
        .brand-header.medium h1 { font-size: 17px; letter-spacing: 5px; text-indent: 5px; }
        .brand-header p {
            font-size: 10px; font-weight: 600; letter-spacing: 2px;
            color: var(--text-dim); margin: 8px 0 0 0; text-transform: uppercase;
        }

        .group { margin-bottom: 14px; position: relative; }
        
        input {
            width: 100%; padding: 16px 20px; background: var(--field); border: 1px solid var(--border);
            color: var(--text-main); outline: none; font-size: 14px; font-weight: 500; box-sizing: border-box;
            border-radius: var(--radius);
            transition: border-color 0.3s, background 0.3s;
        }
        input:focus { border-color: var(--text-dim); }
        input::placeholder { color: var(--text-dim); opacity: 0.5; }

        .strength-meter {
            height: 3px; width: 84%; background: var(--border); margin: -8px auto 8px;
            border-radius: 2px; overflow: hidden; display: none;
        }
        .strength-bar { height: 100%; width: 0; transition: width 0.3s, background 0.3s; }
        
        .strength-tips {
            font-size: 9px; color: var(--text-dim); text-align: center;
            margin-bottom: 15px; display: none; line-height: 1.4;
        }
        .tip.valid { text-decoration: line-through; opacity: 0.4; }

        .eye-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; padding: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        .eye-btn svg { width: 20px; height: 20px; fill: var(--text-dim); transition: fill 0.2s; }
        .eye-btn:hover svg { fill: var(--accent); }

        .btn-main {
            width: 100%; padding: 18px; background: var(--accent); color: var(--bg);
            border: none; font-weight: 900; font-size: 13px; letter-spacing: 2px; cursor: pointer;
            border-radius: var(--radius); text-transform: uppercase;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn-main:active { opacity: 0.8; transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.3; cursor: not-allowed; }

        .nav-footer { display: flex; justify-content: space-between; margin-top: 25px; padding: 0 5px; }
        .nav-footer button { 
            background: none; border: none; color: var(--text-dim); 
            font-size: 11px; font-weight: 600; cursor: pointer;
            transition: color 0.2s;
        }
        .nav-footer button:hover { color: var(--accent); }

        .screen { display: none; position: relative; }
        .screen.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="auth-card">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>

        <div class="mascot-container">
            <canvas id="mascot"></canvas>
        </div>

        <div id="login" class="screen active">
            <div class="brand-header">
                <h1>Slant</h1>
                <p>Нейронный узел</p>
            </div>
            <div class="group"><input type="email" placeholder="ПОЧТА" class="node-input" data-mode="user"></div>
            <div class="group">
                <input type="password" placeholder="ПАРОЛЬ" class="node-input" data-mode="pass" id="logPass">
                <button class="eye-btn" onclick="togglePass('logPass')">
                    <svg id="svg-logPass" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
            </div>
            <button class="btn-main" onclick="processAuth(this)">Войти</button>
            <div class="nav-footer">
                <button onclick="go('lost')">Забыли пароль?</button>
                <button onclick="go('reg')">Регистрация</button>
            </div>
        </div>

        <div id="reg" class="screen">
            <button class="back-btn" onclick="go('login')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <div class="brand-header medium">
                <h1>Регистрация</h1>
                <p>Создание личности</p>
            </div>
            <div class="group"><input type="email" placeholder="ПОЧТА" class="node-input" data-mode="genesis" id="regEmail"></div>
            <div class="group" style="margin-bottom:8px">
                <input type="password" placeholder="ПАРОЛЬ" class="node-input" data-mode="pass" id="regPass" oninput="checkStrength(this.value)">
                <button class="eye-btn" onclick="togglePass('regPass')">
                    <svg id="svg-regPass" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
            </div>
            <div class="strength-meter" id="meter"><div class="strength-bar" id="bar"></div></div>
            <div class="strength-tips" id="tips">
                <span id="t-len" class="tip">8+ символов</span> • 
                <span id="t-cap" class="tip">Заглавная</span> • 
                <span id="t-num" class="tip">Цифра</span>
            </div>
            <div class="group">
                <input type="password" placeholder="ПОВТОРНЫЙ ПАРОЛЬ" class="node-input" data-mode="pass" id="regPassConfirm">
                <button class="eye-btn" onclick="togglePass('regPassConfirm')">
                    <svg id="svg-regPassConfirm" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
            </div>
            <button class="btn-main" onclick="handleRegister(this)">Зарегистрироваться</button>
        </div>

        <div id="lost" class="screen">
            <button class="back-btn" onclick="go('login')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <div class="brand-header small">
                <h1>Восстановление</h1>
                <p>Восстановление личности</p>
            </div>
            <div class="group"><input type="email" placeholder="ПОЧТА" class="node-input" data-mode="recall"></div>
            <button class="btn-main" onclick="processAuth(this)">Отправить код</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mascot');
        const ctx = canvas.getContext('2d', { alpha: false });
        let w, h, points = [], bgPoints = [], comet = null;
        let state = 'idle', isErrorActive = false;
        let activeEyeId = null;
        let extrasActive = false;
        let theme = 'dark';

        // Eye Animation Variables
        let blinkProgress = 1; 
        let isBlinking = false;
        let lastBlinkTime = 0;
        let lookX = 0, lookY = 0;
        let targetLookX = 0, targetLookY = 0;
        let lastLookTime = 0;

        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            const btn = document.getElementById('themeBtn');
            if(theme === 'light') {
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            } else {
                btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            }
            triggerBurst(40);
        }

        let activeToasts = new Set();
        function showToast(text, type = 'error') {
            if(activeToasts.has(text)) return;
            activeToasts.add(text);
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.textContent = text;
            let startX = 0, currentX = 0;
            el.addEventListener('touchstart', e => startX = e.touches[0].clientX);
            el.addEventListener('touchmove', e => {
                currentX = e.touches[0].clientX - startX;
                if(Math.abs(currentX) > 20) {
                    el.style.transform = `translateX(${currentX}px) rotate(${currentX/15}deg)`;
                    el.style.opacity = 1 - Math.abs(currentX)/200;
                }
            });
            el.addEventListener('touchend', () => {
                if(Math.abs(currentX) > 100) remove();
                else { el.style.transform = ''; el.style.opacity = ''; }
            });
            const remove = () => {
                el.style.opacity = '0';
                setTimeout(() => { el.remove(); activeToasts.delete(text); }, 300);
            };
            container.appendChild(el);
            setTimeout(remove, 5000);
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        function checkStrength(p) {
            const meter = document.getElementById('meter');
            const bar = document.getElementById('bar');
            const tips = document.getElementById('tips');
            if(!p) { meter.style.display = 'none'; tips.style.display = 'none'; return; }
            meter.style.display = 'block'; tips.style.display = 'block';
            const conds = { len: p.length >= 8, cap: /[A-Z]/.test(p), num: /[0-9]/.test(p) };
            Object.keys(conds).forEach(k => { document.getElementById('t-'+k).className = conds[k] ? 'tip valid' : 'tip'; });
            let score = Object.values(conds).filter(Boolean).length;
            const colors = ['#ff3b30', '#ffcc00', '#34c759', '#ffffff'];
            bar.style.width = (score + 1) * 25 + '%';
            bar.style.background = colors[score];
        }

        const eyeOpenPath = "M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z";
        // Corrected Cross (X) Path - diagonal lines
        const eyeCrossPath = "M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zm4.7 10.8l-1.4 1.4L12 13.4l-3.3 3.3-1.4-1.4 3.3-3.3-3.3-3.3 1.4-1.4 3.3 3.3 3.3-3.3 1.4 1.4-3.3 3.3 3.3 3.3z";

        function togglePass(id) {
            const input = document.getElementById(id);
            const path = document.getElementById('svg-' + id).querySelector('path');
            const isShowing = input.type === 'text';
            input.type = isShowing ? 'password' : 'text';
            path.setAttribute('d', isShowing ? eyeCrossPath : eyeOpenPath);
            activeEyeId = input.type === 'text' ? id : null;
            triggerBurst(25);
        }

        class Point {
            constructor(isBg = false, isExtra = false) {
                this.isBg = isBg;
                this.isExtra = isExtra;
                this.init();
            }
            init() {
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.originX = this.x; this.originY = this.y;
                this.vx = (Math.random() - 0.5) * (this.isBg ? 0.25 : 0.45);
                this.vy = (Math.random() - 0.5) * (this.isBg ? 0.25 : 0.45);
                this.offX = 0; this.offY = 0;
                this.r = this.isBg ? (0.4 + Math.random() * 0.6) : (1.1 + Math.random());
                this.baseR = this.r; this.angle = Math.random() * Math.PI * 2;
                this.acc = 0.04 + Math.random() * 0.03;
                this.isAffected = false;
                this.id = Math.random();
                this.die = false;
            }
            update() {
                let tx = this.originX, ty = this.originY;
                let time = Date.now() * 0.003;

                if (this.isBg) {
                    this.originX += this.vx; this.originY += this.vy;
                    if (this.originX < 0 || this.originX > w) this.vx *= -1;
                    if (this.originY < 0 || this.originY > h) this.vy *= -1;
                    tx = this.originX; ty = this.originY;
                } else if (this.die) {
                    let dx = this.x - w/2, dy = this.y - h/2;
                    let dist = Math.sqrt(dx*dx + dy*dy) || 1;
                    tx = this.x + (dx/dist) * 150; 
                    ty = this.y + (dy/dist) * 150;
                    this.acc = 0.12;
                } else {
                    if (state === 'pass') {
                        let t = (this.id * Math.PI * 2);
                        let a = 85, b = 42;
                        
                        if (activeEyeId) {
                            if (this.id > 0.4) { 
                                tx = w/2 + a * Math.cos(t); 
                                ty = h/2 + (b * Math.sin(t) * blinkProgress); 
                            } else { 
                                tx = w/2 + 20 * Math.cos(t*2) + lookX; 
                                ty = h/2 + (20 * Math.sin(t*2) * (blinkProgress < 0.2 ? 0.1 : 1)) + lookY; 
                            }
                        } else {
                            if (this.id > 0.4) { 
                                tx = w/2 + a * Math.cos(t); 
                                ty = h/2 + (b * Math.sin(t) * blinkProgress); 
                            } else if (this.id > 0.1) {
                                // Diagonal X Line 1
                                let prog = (this.id - 0.1) / 0.3 - 0.5;
                                tx = w/2 + (prog * 30) + lookX;
                                ty = h/2 + (prog * 30 * blinkProgress) + lookY;
                            } else {
                                // Diagonal X Line 2
                                let prog = (this.id / 0.1) - 0.5;
                                tx = w/2 + (prog * 30) + lookX;
                                ty = h/2 - (prog * 30 * blinkProgress) + lookY;
                            }
                        }
                    } else if (state === 'idle') {
                        this.originX += this.vx; this.originY += this.vy;
                        if (this.originX < 0 || this.originX > w) this.vx *= -1;
                        if (this.originY < 0 || this.originY > h) this.vy *= -1;
                        tx = this.originX; ty = this.originY;
                    } else if (state === 'user') {
                        this.angle += 0.02; tx = w/2 + Math.cos(this.angle + this.id) * 70; ty = h/2 + Math.sin(this.angle + this.id) * 45;
                    } else if (state === 'genesis') { 
                        let vPos = (this.id % 0.5) * 2; 
                        let strand = this.id > 0.5 ? Math.PI : 0; 
                        let twistFreq = 2.5; 
                        let rotSpeed = time * 0.6;
                        let hAngle = (vPos * Math.PI * twistFreq) - rotSpeed + strand;
                        tx = w/2 + Math.cos(hAngle) * 40;
                        ty = h/2 - 60 + (vPos * 120);
                    } else if (state === 'recall') { 
                        let vPos = this.id; 
                        let swirlAngle = (vPos * Math.PI * 5) + (time * 0.4); 
                        let radius = (1.1 - vPos) * 65 + 8; 
                        tx = w/2 + Math.cos(swirlAngle) * radius;
                        ty = h/2 - 55 + (vPos * 110);
                    } else if (state === 'loading') {
                        this.angle += 0.05; let t = this.angle + (this.baseR * 10);
                        let scale = 75, denom = 1 + Math.pow(Math.sin(t), 2);
                        tx = w/2 + (scale * Math.cos(t)) / denom; ty = h/2 + (scale * Math.sin(t) * Math.cos(t)) / denom;
                    }
                }

                if (isErrorActive && !this.isBg) this.r += (this.baseR * 2.5 - this.r) * 0.1;
                else this.r += (this.baseR - this.r) * 0.1;

                this.offX *= 0.92; this.offY *= 0.92;
                this.x += (tx + this.offX - this.x) * this.acc;
                this.y += (ty + this.offY - this.y) * this.acc;
            }
            draw() {
                let baseColor = getComputedStyle(document.documentElement).getPropertyValue('--particle-color').trim();
                let color = this.isBg ? (theme === 'dark' ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.08)') : baseColor;
                if (!this.isBg && (isErrorActive || (this.isAffected && Math.sin(Date.now()*0.2) > 0))) color = '#ff3b30';
                ctx.fillStyle = color; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2); ctx.fill();
            }
        }

        class Comet {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() < 0.5 ? -100 : w + 100; this.y = Math.random() * h;
                this.vx = (this.x < 0 ? 1 : -1) * (12 + Math.random() * 8); this.vy = (Math.random() - 0.5) * 6;
                this.history = []; this.active = true;
            }
            update() {
                this.history.push({x: this.x, y: this.y});
                if (this.history.length > 25) this.history.shift();
                this.x += this.vx; this.y += this.vy;
                if (Math.abs(this.x) > w + 200 || Math.abs(this.y) > h + 200) this.active = false;
            }
            draw() {
                ctx.beginPath();
                let baseColor = theme === 'dark' ? '255,255,255' : '0,0,0';
                for(let i=0; i<this.history.length; i++) {
                    let op = i / this.history.length;
                    ctx.strokeStyle = `rgba(${baseColor},${op * 0.2})`;
                    ctx.lineWidth = op * 1.5;
                    let next = this.history[i+1] || this;
                    ctx.moveTo(this.history[i].x, this.history[i].y); ctx.lineTo(next.x, next.y);
                }
                ctx.stroke();
            }
        }

        function init() {
            w = canvas.width = canvas.offsetWidth; h = canvas.height = canvas.offsetHeight;
            points = []; bgPoints = [];
            for(let i=0; i<45; i++) points.push(new Point(false));
            for(let i=0; i<50; i++) bgPoints.push(new Point(true));
        }

        function clearExtras() {
            if (!extrasActive) return;
            extrasActive = false;
            points.forEach(p => { if(p.isExtra) p.die = true; });
            triggerBurst(45);
            // Optimization: Remove dead points from array after animation
            setTimeout(() => {
                points = points.filter(p => !p.die);
            }, 600);
        }

        function triggerBurst(power, isRed = false, selective = false) {
            if(isRed && !selective) { isErrorActive = true; setTimeout(() => isErrorActive = false, 500); }
            points.forEach(p => {
                if(selective) {
                    p.isAffected = Math.random() > 0.7;
                    if(!p.isAffected) return;
                    setTimeout(() => p.isAffected = false, 400);
                }
                let dx = p.x - w/2, dy = p.y - h/2;
                let dist = Math.sqrt(dx*dx + dy*dy) || 1;
                p.offX += (dx/dist) * (power * (selective ? 1.5 : 1));
                p.offY += (dy/dist) * (power * (selective ? 1.5 : 1));
            });
        }

        function updateEyeAnimation() {
            const now = Date.now();
            
            // Blinking Logic: Periodic and smooth
            if (!isBlinking && now - lastBlinkTime > 3000 + Math.random() * 4000) {
                isBlinking = true;
            }
            if (isBlinking) {
                blinkProgress -= 0.15;
                if (blinkProgress <= 0) {
                    blinkProgress = 0;
                    isBlinking = false;
                    lastBlinkTime = now;
                }
            } else {
                blinkProgress += (1 - blinkProgress) * 0.15;
            }

            // Looking Around: Smooth lerp to random targets
            if (now - lastLookTime > 2000 + Math.random() * 3000) {
                targetLookX = (Math.random() - 0.5) * 18;
                targetLookY = (Math.random() - 0.5) * 12;
                lastLookTime = now;
            }
            lookX += (targetLookX - lookX) * 0.05;
            lookY += (targetLookY - lookY) * 0.05;
        }

        function render() {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
            ctx.fillRect(0, 0, w, h);
            
            updateEyeAnimation();

            if (!comet && Math.random() < 0.002) comet = new Comet();
            if (comet) { comet.update(); comet.draw(); if (!comet.active) comet = null; }
            bgPoints.forEach(p => { p.update(); p.draw(); });
            
            for(let i = points.length - 1; i >= 0; i--) {
                let p1 = points[i]; 
                p1.update(); 
                p1.draw();
                
                if(p1.die && (p1.x < -300 || p1.x > w+300 || p1.y < -300 || p1.y > h+300)) {
                    points.splice(i, 1);
                    continue;
                }

                for(let j = i + 1; j < points.length; j++) {
                    let p2 = points[j];
                    if(p1.die || p2.die) continue;
                    let dx = p1.x - p2.x, dy = p1.y - p2.y;
                    let d = dx*dx + dy*dy;
                    let limit = (state === 'genesis' || state === 'pass') ? 1800 : 2600;
                    
                    if (d < limit) {
                        let op = 1 - Math.sqrt(d)/Math.sqrt(limit);
                        let baseColor = theme === 'dark' ? '255,255,255' : '0,0,0';
                        ctx.strokeStyle = p1.isAffected ? `rgba(255,50,50,${op*0.8})` : `rgba(${baseColor},${op*0.22})`;
                        ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(render);
        }

        document.querySelectorAll('.node-input').forEach(el => {
            el.addEventListener('focus', () => { 
                if(state === 'loading') return;
                let newMode = el.dataset.mode;
                if (newMode === 'pass' || newMode === 'genesis' || newMode === 'recall') {
                    if (!extrasActive) {
                        extrasActive = true;
                        // Added 40 additional particles for better density
                        let count = (newMode === 'pass') ? 85 : 45;
                        for(let i=0; i<count; i++) points.push(new Point(false, true));
                    }
                } else if (extrasActive) {
                    clearExtras();
                }
                state = newMode;
            });

            el.addEventListener('blur', () => { 
                setTimeout(() => {
                    const active = document.activeElement;
                    if(state !== 'loading' && (!active || !active.classList.contains('node-input'))) {
                        clearExtras();
                        state = 'idle';
                    }
                }, 100);
            });

            el.addEventListener('input', (e) => {
                if(state === 'loading') return;
                if(e.inputType === 'deleteContentBackward') triggerBurst(18, true, true);
                else triggerBurst(8);
            });
        });

        function go(id) {
            if(state === 'loading') return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            clearExtras();
            state = 'idle'; activeEyeId = null;
            document.querySelectorAll('.eye-btn svg path').forEach(p => p.setAttribute('d', eyeCrossPath));
            document.querySelectorAll('input[type="text"]').forEach(i => { if(i.dataset.mode==='pass') i.type = 'password'; });
            triggerBurst(30); 
        }

        // New Registration Handler
        function handleRegister(btn) {
            const email = document.getElementById('regEmail').value;
            const p1 = document.getElementById('regPass').value;
            const p2 = document.getElementById('regPassConfirm').value;
            
            if(!validateEmail(email)) { triggerBurst(50, true); showToast("Некорректный адрес почты"); return; }
            if(p1.length < 8) { triggerBurst(50, true); showToast("Пароль слишком короткий"); return; }
            if(p1 !== p2) { triggerBurst(50, true); showToast("Пароли не совпадают"); return; }
            
            processAuth(btn);
        }

        function processAuth(btn) {
            const activeScreen = document.querySelector('.screen.active');
            const inputs = activeScreen.querySelectorAll('input');
            let empty = false, emailValid = true;
            inputs.forEach(i => { 
                if(!i.value) empty = true;
                if(i.type === 'email' && !validateEmail(i.value)) emailValid = false;
            });
            if(empty) { triggerBurst(50, true); showToast("Заполните все поля"); return; }
            if(!emailValid) { triggerBurst(50, true); showToast("Некорректная почта"); return; }
            
            clearExtras();
            state = 'loading'; btn.disabled = true;
            const oldText = btn.textContent; btn.textContent = 'ОБРАБОТКА...';
            setTimeout(() => {
                state = 'idle'; btn.disabled = false; btn.textContent = oldText;
                showToast("УЗЕЛ СИНХРОНИЗИРОВАН", 'success');
            }, 2500);
        }

        window.addEventListener('resize', init);
        init(); render();
        document.querySelectorAll('.eye-btn svg path').forEach(p => p.setAttribute('d', eyeCrossPath));
    </script>
</body>
</html>
